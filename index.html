<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SAMBASHIVA MILK AGENCY</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --orange:#f97316;
    --orange-dark:#d65b12;
    --bg:#faf7f3;
    --card:#ffffff;
    --muted:#6b7280;
    --input-h:40px;
    --header-h:96px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#222;padding-bottom:140px}
  header{position:sticky;top:0;z-index:320;background:linear-gradient(90deg,var(--orange),var(--orange-dark));color:white;padding:12px 14px;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  .container{max-width:1200px;margin:0 auto;padding:0 14px}
  .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{width:44px;height:44px;flex:0 0 44px}
  .title-block{text-align:center;flex:1}
  .title{font-size:1.18rem;font-weight:800;margin:0;display:flex;align-items:center;justify-content:center;gap:10px;color:#fff}
  .subtitle{font-size:0.92rem;margin-top:6px;color:#fff}
  .date-input{background:var(--card);border:0;padding:6px 10px;border-radius:8px;height:34px;font-weight:700}
  .controls{display:flex;gap:8px;justify-content:flex-end;margin:12px 0;align-items:center;flex-wrap:wrap}
  .btn{background:var(--orange);color:#fff;border:0;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px}
  .btn.ghost{background:#fff;color:var(--orange);border:1px solid rgba(0,0,0,0.06)}
  .btn.clear{background:#ef4444}
  .btn.small{padding:6px 8px;font-size:13px}
  .price-panel{display:flex;gap:8px;overflow:auto;padding-bottom:8px;margin-bottom:6px}
  .price-item{background:var(--card);padding:8px;border-radius:8px;min-width:86px;box-shadow:0 6px 18px rgba(2,6,23,0.04);text-align:center}
  .price-item label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  .price-item input{width:78px;padding:6px;border-radius:6px;border:1px solid #e6e6e6;height:34px;text-align:center;font-size:13px}
  .table-wrap{background:transparent;border-radius:10px;box-shadow:none;padding:0}
  table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:13px;background:var(--card);box-shadow:0 8px 30px rgba(2,6,23,0.06);border-radius:8px;overflow:hidden}
  thead th{background:linear-gradient(180deg,var(--orange),var(--orange-dark));color:white;position:sticky;top:calc(var(--header-h) - 8px);z-index:280;padding:8px 6px}
  th,td{padding:6px;border-bottom:1px solid #f3f3f3;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;background:transparent}
  .planned-row td{background:#fff7f0;color:#4b2f0a;font-weight:800}
  input[type="number"],input[type="text"],input[type="tel"]{padding:6px;border-radius:6px;border:1px solid #eaeaea;text-align:center;font-size:13px;height:34px;min-width:44px;background:#fff}
  .total-cell,.due-cell{font-weight:800;background:transparent}
  .send-btn{background:#25D366;border:0;color:white;padding:6px 8px;border-radius:6px;cursor:pointer;height:34px;font-size:13px}
  .delete-btn{background:#ef4444;border:0;color:white;padding:6px 8px;border-radius:6px;cursor:pointer;height:34px;font-size:13px}
  .custom-btn{background:#ffd27a;border:0;color:#6b3d00;padding:6px 8px;border-radius:6px;cursor:pointer;height:34px;font-size:13px}
  .custom-price-row td{background:#fff8ed;padding:8px}
  .footer-note{text-align:center;color:var(--muted);margin-top:8px}
  .bottom-summary{margin-top:12px;background:#fff6ee;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  .summary-grid{display:grid;grid-template-columns:180px repeat(8,1fr);gap:8px;align-items:center;font-size:13px}
  .summary-label{font-weight:800;color:#4b2f0a}
  .summary-cell{background:var(--card);padding:8px;border-radius:6px;text-align:center}
  .summary-input{width:80px;padding:6px;border-radius:6px;border:1px solid #eaeaea;text-align:center;background:#fff}
  .toast{position:fixed;right:16px;bottom:110px;background:#111;color:#fff;padding:10px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .18s;z-index:360}
  .toast.show{opacity:1;transform:none}

  /* tuned widths for columns */
  .col-shop { width:260px; min-width:160px; text-align:left; padding-left:12px; }
  .col-mobile { width:150px; min-width:110px; }
  .small-num { width:64px; min-width:48px; max-width:86px; }

  @media (max-width:899px){
    .container{padding:0 8px}
    table{min-width:980px} /* allow the table to be scrollable on small screens */
    .price-item input{width:72px}
  }
</style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div style="display:flex;align-items:center;gap:8px">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 100 100" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="48" fill="#fff" stroke="#f97316" stroke-width="4"/>
            <text x="50" y="58" font-family="sans-serif" font-weight="800" font-size="26" fill="#f97316" text-anchor="middle">HAP</text>
          </svg>
        </div>
      </div>

      <div class="title-block" aria-live="polite">
        <div class="title" role="banner">
          <span>SAMBASHIVA MILK AGENCY</span>
        </div>
        <div class="subtitle">Prop: <strong>K. AJAY KUMAR REDDY</strong> &nbsp; | &nbsp; Mobile: <strong>7330892694</strong></div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <input id="dateInput" class="date-input" type="date" />
        <div style="width:42px;height:42px">
          <svg viewBox="0 0 64 64" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <rect width="64" height="64" rx="8" fill="#fff" stroke="#f97316" stroke-width="2"/>
            <path d="M32 10c6 0 10 3 10 7s-4 7-10 7-10-3-10-7 4-7 10-7z" fill="#f97316"/>
            <path d="M22 32c0-4 4-7 10-7s10 3 10 7v12H22V32z" fill="#fff"/>
          </svg>
        </div>
      </div>
    </div>
  </header>

  <main style="padding:14px 12px 160px">
    <div class="container">

      <div class="price-panel" aria-label="Global prices">
        <div class="price-item"><label>TM (â‚¹)</label><input id="price_TM" type="number" min="0" value="57"></div>
        <div class="price-item"><label>SM (â‚¹)</label><input id="price_SM" type="number" min="0" value="67"></div>
        <div class="price-item"><label>SML M (â‚¹)</label><input id="price_SMM" type="number" min="0" value="45"></div>
        <div class="price-item"><label>SML C (â‚¹)</label><input id="price_SMC" type="number" min="0" value="45"></div>
        <div class="price-item"><label>A400 (â‚¹)</label><input id="price_A400" type="number" min="0" value="70"></div>
        <div class="price-item"><label>H500 (â‚¹)</label><input id="price_H500" type="number" min="0" value="86"></div>
        <div class="price-item"><label>FCM (â‚¹)</label><input id="price_FC400" type="number" min="0" value="77"></div>
        <div class="price-item"><label>FC1L (â‚¹)</label><input id="price_FC1L" type="number" min="0" value="76"></div>
      </div>

      <div class="controls" role="toolbar" aria-label="Main controls">
        <div style="flex:1"></div>
        <button id="addBtn" class="btn">+ Add Shop</button>
        <button id="downloadPdfBtn" class="btn small" title="Download PDF">Download PDF</button>
        <button id="copyPrevBtn" class="btn ghost small" title="Copy shops from previous day">ðŸ“‹ Copy Prev Day</button>
        <button id="saveBtn" class="btn ghost small">Save Data</button>
        <button id="clearBtn" class="btn clear small" title="Clear all data">Clear All</button>
      </div>

      <div class="table-wrap" role="region" aria-label="Shops table">
        <table id="dataTable" aria-describedby="tableDesc">
          <thead>
            <tr>
              <th class="col-shop">Full name</th>
              <th class="col-mobile">Mobile</th>
              <th class="small-num">TM</th>
              <th class="small-num">SM</th>
              <th class="small-num">SML M</th>
              <th class="small-num">SML C</th>
              <th class="small-num">A400</th>
              <th class="small-num">H500</th>
              <th class="small-num">FCM</th>
              <th class="small-num">FC1L</th>
              <th class="small-num">Total</th>
              <th class="small-num">Paid</th>
              <th class="small-num">Due</th>
              <th class="small-num">Send</th>
              <th class="small-num">Custom</th>
              <th class="small-num">Delete</th>
            </tr>
          </thead>

          <tbody>
            <tr class="planned-row">
              <td style="text-align:left;padding-left:8px">Planned litres to sell (editable)</td>
              <td>â€”</td>
              <td><input id="plan_TM" type="number" min="0" value="0"></td>
              <td><input id="plan_SM" type="number" min="0" value="0"></td>
              <td><input id="plan_SMM" type="number" min="0" value="0"></td>
              <td><input id="plan_SMC" type="number" min="0" value="0"></td>
              <td><input id="plan_A400" type="number" min="0" value="0"></td>
              <td><input id="plan_H500" type="number" min="0" value="0"></td>
              <td><input id="plan_FC400" type="number" min="0" value="0"></td>
              <td><input id="plan_FC1L" type="number" min="0" value="0"></td>
              <td id="plan_total">0</td>
              <td colspan="5"></td>
            </tr>
          </tbody>

          <tbody id="dataBody"></tbody>

          <tfoot>
            <tr class="summary-row">
              <td style="text-align:left;padding-left:8px">Totals per column</td><td>â€”</td>
              <td id="tot_tm">0</td><td id="tot_sm">0</td><td id="tot_smm">0</td><td id="tot_smc">0</td>
              <td id="tot_a400">0</td><td id="tot_h500">0</td><td id="tot_fc400">0</td><td id="tot_fc1l">0</td>
              <td id="tot_total">0</td><td id="tot_paid">0</td><td id="tot_due">0</td><td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top:12px;text-align:center;font-weight:700">
        Grand Total: <span id="grandTotal">â‚¹0</span><br>
        Total Litres Sold: <span id="grandLitres">0</span> Ltrs
      </div>

      <div class="footer-note" style="margin-top:8px;color:var(--muted);font-size:13px">Saved locally on this device â€” data persists after refresh/close. (Last 365 days retained)</div>

      <div class="bottom-summary" id="bottomSummary" aria-hidden="false">
        <div class="summary-grid">
          <div class="summary-label">Metric</div>
          <div class="summary-label">TM</div><div class="summary-label">SM</div><div class="summary-label">SML M</div><div class="summary-label">SML C</div>
          <div class="summary-label">A400</div><div class="summary-label">H500</div><div class="summary-label">FCM</div><div class="summary-label">FC1L</div>

          <div class="summary-label">Total Litres Sold</div>
          <div class="summary-cell"><span id="b_sold_TM">0</span></div>
          <div class="summary-cell"><span id="b_sold_SM">0</span></div>
          <div class="summary-cell"><span id="b_sold_SMM">0</span></div>
          <div class="summary-cell"><span id="b_sold_SMC">0</span></div>
          <div class="summary-cell"><span id="b_sold_A400">0</span></div>
          <div class="summary-cell"><span id="b_sold_H500">0</span></div>
          <div class="summary-cell"><span id="b_sold_FC400">0</span></div>
          <div class="summary-cell"><span id="b_sold_FC1L">0</span></div>

          <div class="summary-label">Planned Litres</div>
          <div class="summary-cell"><input id="b_plan_TM" class="summary-input" type="number" value="0"></div>
          <div class="summary-cell"><input id="b_plan_SM" class="summary-input" type="number" value="0"></div>
          <div class="summary-cell"><input id="b_plan_SMM" class="summary-input" type="number" value="0"></div>
          <div class="summary-cell"><input id="b_plan_SMC" class="summary-input" type="number" value="0"></div>
          <div class="summary-cell"><input id="b_plan_A400" class="summary-input" type="number" value="0"></div>
          <div class="summary-cell"><input id="b_plan_H500" class="summary-input" type="number" value="0"></div>
          <div class="summary-cell"><input id="b_plan_FC400" class="summary-input" type="number" value="0"></div>
          <div class="summary-cell"><input id="b_plan_FC1L" class="summary-input" type="number" value="0"></div>

          <div class="summary-label">Remaining</div>
          <div class="summary-cell"><span id="b_remain_TM">0</span></div>
          <div class="summary-cell"><span id="b_remain_SM">0</span></div>
          <div class="summary-cell"><span id="b_remain_SMM">0</span></div>
          <div class="summary-cell"><span id="b_remain_SMC">0</span></div>
          <div class="summary-cell"><span id="b_remain_A400">0</span></div>
          <div class="summary-cell"><span id="b_remain_H500">0</span></div>
          <div class="summary-cell"><span id="b_remain_FC400">0</span></div>
          <div class="summary-cell"><span id="b_remain_FC1L">0</span></div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast" aria-hidden="true"></div>

<!-- libs for PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(() => {
  const STORAGE_PREFIX = 'milkData_';
  const MAX_DAYS = 365;
  const todayStr = d => d.toISOString().slice(0,10);
  const TODAY = todayStr(new Date());

  const dateInput = document.getElementById('dateInput');
  const addBtn = document.getElementById('addBtn');
  const dataBody = document.getElementById('dataBody');
  const toast = document.getElementById('toast');

  const showToast = (msg, ms=2000, undoFn=null)=>{
    toast.innerHTML = undoFn ? `${msg} <button style="margin-left:8px;padding:3px 8px;border:0;border-radius:4px;background:#fff;color:#111;cursor:pointer">Undo</button>` : msg;
    toast.classList.add('show');
    toast.setAttribute('aria-hidden','false');
    if(undoFn){
      const btn = toast.querySelector('button');
      btn.onclick = ()=>{ undoFn(); hideToast(); };
    }
    clearTimeout(toast._t);
    toast._t = setTimeout(hideToast, ms);
  };
  const hideToast = ()=>{
    toast.classList.remove('show');
    toast.setAttribute('aria-hidden','true');
  };

  function readGlobalPricesSafe(){
    const ids=['TM','SM','SMM','SMC','A400','H500','FC400','FC1L'];
    const o={};
    ids.forEach(id=>{
      const el=document.getElementById('price_'+id);
      if(el) o[id.replace('SMM','SMALL M').replace('SMC','SMALL C').replace('FC400','FC400').replace('FC1L','FC1L')]=Number(el.value||0);
    });
    return o;
  }

  function formatNum(n){return (!isFinite(n)?'0':(Math.round(n)==n?Math.round(n):n.toFixed(2)));}

  // ---- Row Creation ----
  function createRow(data){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="shop" placeholder="Full name"></td>
      <td><input class="mobile" type="tel" placeholder="Mobile"></td>
      <td><input class="tm" type="number"></td>
      <td><input class="sm" type="number"></td>
      <td><input class="smm" type="number"></td>
      <td><input class="smc" type="number"></td>
      <td><input class="a400" type="number"></td>
      <td><input class="h500" type="number"></td>
      <td><input class="fc400" type="number"></td>
      <td><input class="fc1l" type="number"></td>
      <td class="total-cell">0</td>
      <td><input class="paid" type="number"></td>
      <td class="due-cell">0</td>
      <td><button class="send-btn">Send</button></td>
      <td><button class="custom-btn">Edit</button></td>
      <td><button class="delete-btn">Delete</button></td>`;
    if(data){
      tr.querySelector('.shop').value=data.shop||'';
      tr.querySelector('.mobile').value=data.mobile||'';
      ['tm','sm','smm','smc','a400','h500','fc400','fc1l','paid'].forEach(k=>{
        if(data[k.toUpperCase()]) tr.querySelector('.'+k).value=data[k.toUpperCase()];
      });
      if(data.customPrices) tr._customPrices=data.customPrices;
    }

    tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',()=>{calcRow(tr);updateAll();autosaveSilent();}));
    tr.querySelector('.delete-btn').addEventListener('click',()=>deleteRow(tr));
    tr.querySelector('.custom-btn').addEventListener('click',()=>toggleCustom(tr));
    tr.querySelector('.send-btn').addEventListener('click',()=>sendWhatsApp(tr));
    return tr;
  }

  function calcRow(tr){
    const g=readGlobalPricesSafe();
    const c=tr._customPrices||{};
    const v=n=>Number(tr.querySelector('.'+n).value||0);
    const tm=v('tm'),sm=v('sm'),smm=v('smm'),smc=v('smc'),a400=v('a400'),h500=v('h500'),fc400=v('fc400'),fc1l=v('fc1l'),paid=v('paid');
    const prices={
      TM:c.TM??g.TM,SM:c.SM??g.SM,'SMALL M':c['SMALL M']??g['SMALL M'],'SMALL C':c['SMALL C']??g['SMALL C'],
      A400:c.A400??g.A400,H500:c.H500??g.H500,FC400:c.FC400??g.FC400,FC1L:c.FC1L??g.FC1L
    };
    const total=tm*prices.TM+sm*prices.SM+smm*prices['SMALL M']+smc*prices['SMALL C']+a400*prices.A400+h500*prices.H500+fc400*prices.FC400+fc1l*prices.FC1L;
    const due=Math.max(0,total-paid);
    tr.querySelector('.total-cell').textContent=formatNum(total);
    tr.querySelector('.due-cell').textContent=formatNum(due);
    updateRowStyle(tr);
  }

  function updateRowStyle(tr){
    tr.style.background='';
    if(tr._customPrices) tr.style.background='#fff8e1';
    const due=Number(tr.querySelector('.due-cell').textContent||0);
    if(due>0) tr.style.background='#ffe5e5';
  }

  function toggleCustom(tr){
    if(tr._customOpen){ tr._customEl.remove(); tr._customOpen=false; return;}
    const row=document.createElement('tr');
    row.classList.add('custom-price-row');
    row.innerHTML=`<td colspan="16" style="background:#fff8ed;padding:8px">
      <strong>Custom Prices:</strong>
      ${['TM','SM','SMALL M','SMALL C','A400','H500','FC400','FC1L'].map(t=>`${t} â‚¹<input data-k="${t}" type="number" style="width:80px">`).join(' ')}
      <button class="btn small save">Save</button>
      <button class="btn small ghost cancel">Cancel</button>
    </td>`;
    tr.insertAdjacentElement('afterend',row);
    tr._customEl=row; tr._customOpen=true;
    const g=readGlobalPricesSafe();
    row.querySelectorAll('input').forEach(i=>{
      const k=i.dataset.k;
      i.value=(tr._customPrices && tr._customPrices[k])||g[k];
    });
    row.querySelector('.save').onclick=()=>{
      const vals={}; row.querySelectorAll('input').forEach(i=>vals[i.dataset.k]=Number(i.value||0));
      tr._customPrices=vals; calcRow(tr); updateAll(); autosaveSilent(); showToast('Custom prices saved');
    };
    row.querySelector('.cancel').onclick=()=>{row.remove();tr._customOpen=false;};
  }

  // ---- Delete with undo ----
  let lastDeleted=null;
  function deleteRow(tr){
    if(!confirm('Are you sure you want to delete this shop?')) return;
    lastDeleted={html:tr.outerHTML,index:[...dataBody.children].indexOf(tr)};
    tr.remove();
    updateAll();autosaveSilent();
    showToast('Shop deleted.',4000,()=>{ if(lastDeleted){ const temp=document.createElement('tbody'); temp.innerHTML=lastDeleted.html; const restored=temp.firstChild; if(lastDeleted.index>=dataBody.children.length)dataBody.appendChild(restored); else dataBody.insertBefore(restored,dataBody.children[lastDeleted.index]); attachEvents(restored); updateAll(); autosaveSilent(); showToast('Restored'); lastDeleted=null; }});
  }

  function attachEvents(tr){
    tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',()=>{calcRow(tr);updateAll();autosaveSilent();}));
    tr.querySelector('.delete-btn').addEventListener('click',()=>deleteRow(tr));
    tr.querySelector('.custom-btn').addEventListener('click',()=>toggleCustom(tr));
    tr.querySelector('.send-btn').addEventListener('click',()=>sendWhatsApp(tr));
  }

  // ---- WhatsApp ----
  function sendWhatsApp(tr){
    const shop=tr.querySelector('.shop').value||'Customer';
    let mobile=(tr.querySelector('.mobile').value||'').replace(/\D/g,'');
    if(!mobile){alert('Enter mobile');return;}
    if(mobile.length>10&&mobile.startsWith('91'))mobile=mobile.slice(-10);
    if(mobile.length!=10){alert('Invalid number');return;}
    const total=tr.querySelector('.total-cell').textContent;
    const due=tr.querySelector('.due-cell').textContent;
    const date=dateInput.value||TODAY;
    const msg=`Hello ${shop}, your milk bill for ${date}: Total â‚¹${total}, Due â‚¹${due}. - Sambashiva Milk Agency`;
    window.open(`https://wa.me/91${mobile}?text=${msg}`,'_blank');
  }

  function updateAll(){
    dataBody.querySelectorAll('tr').forEach(tr=>calcRow(tr));
  }

  function collectRows(){
    const rows=[]; dataBody.querySelectorAll('tr').forEach(tr=>{
      if(tr.classList.contains('custom-price-row'))return;
      rows.push({
        shop:tr.querySelector('.shop').value,mobile:tr.querySelector('.mobile').value,
        TM:tr.querySelector('.tm').value,SM:tr.querySelector('.sm').value,SMALLM:tr.querySelector('.smm').value,
        SMALLC:tr.querySelector('.smc').value,A400:tr.querySelector('.a400').value,H500:tr.querySelector('.h500').value,
        FC400:tr.querySelector('.fc400').value,FC1L:tr.querySelector('.fc1l').value,paid:tr.querySelector('.paid').value,
        customPrices:tr._customPrices||null
      });
    });
    return rows;
  }

  function saveForDate(d){
    const payload={rows:collectRows()}; localStorage.setItem(STORAGE_PREFIX+d,JSON.stringify(payload));
  }
  const autosaveSilent=()=>saveForDate(dateInput.value||TODAY);

  function loadForDate(d){
    const raw=localStorage.getItem(STORAGE_PREFIX+d);
    dataBody.innerHTML='';
    if(raw){
      try{
        const data=JSON.parse(raw);
        if(data.rows) data.rows.forEach(r=>{const tr=createRow(r);dataBody.appendChild(tr);calcRow(tr);});
      }catch(e){}
    } else dataBody.appendChild(createRow());
    updateAll();
  }

  addBtn.onclick=()=>{const tr=createRow();dataBody.appendChild(tr);calcRow(tr);autosaveSilent();};
  dateInput.value=TODAY;
  loadForDate(TODAY);
})();
</script>
</body>
</html>
