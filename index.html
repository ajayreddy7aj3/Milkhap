<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SAMBASHIVA MILK AGENCY</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --orange:#f97316;
    --orange-dark:#d65b12;
    --muted:#6b7280;
    --bg:#faf7f3;
    --card:#ffffff;
    --accent:#ffd27a;
    --danger:#fee2e2;
    --success:#ecfdf5;
    --input-h:36px;
    --max-width:1180px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#222; -webkit-font-smoothing:antialiased;}
  header{position:sticky;top:0;z-index:120;background:linear-gradient(90deg,var(--orange),var(--orange-dark));color:white;padding:12px 14px;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  .container{max-width:var(--max-width);margin:0 auto;padding:0 14px}
  .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{width:48px;height:48px;flex:0 0 48px}
  .title-block{flex:1;text-align:center}
  .title{font-size:1.12rem;font-weight:800;color:#fff;margin:0}
  .subtitle{font-size:0.85rem;color:#fff;margin-top:6px}
  .date-input{background:var(--card);border:0;padding:6px 10px;border-radius:8px;height:34px;font-weight:700}
  .top-controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:12px 0;flex-wrap:wrap}
  .btn{background:var(--orange);color:#fff;border:0;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn.ghost{background:#fff;color:var(--orange);border:1px solid rgba(0,0,0,0.06)}
  .btn.clear{background:#ef4444}
  .btn.small{padding:6px 8px;font-size:13px}
  .price-row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;margin-bottom:8px}
  .price-card{background:var(--card);padding:8px;border-radius:8px;min-width:82px;box-shadow:0 6px 18px rgba(2,6,23,0.04);text-align:center}
  .price-card label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  .price-card input{width:72px;padding:6px;border-radius:6px;border:1px solid #eaeaea;height:var(--input-h);text-align:center;background:#fff}

  /* cards grid */
  .cards-wrap{display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:12px}
  .shop-card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(2,6,23,0.06);display:flex;flex-direction:column;gap:8px;min-height:120px}
  .shop-card.yellow{box-shadow:0 10px 30px rgba(200,140,20,0.06);background:linear-gradient(180deg,#fffaf0,#fff8ef)}
  .shop-card.red{background:linear-gradient(180deg,#fff5f5,#fff0f0)}
  .shop-top{display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
  .shop-name {font-weight:800;font-size:15px;line-height:1.1}
  .shop-mobile {color:var(--muted);font-size:13px;margin-top:6px}
  .amounts {display:flex;gap:8px;align-items:center;font-size:13px}
  .amount-box{background:#fff;border-radius:8px;padding:6px 8px;border:1px solid #f0e7de;display:flex;flex-direction:column;align-items:center;min-width:78px}
  .amount-box strong{font-size:14px}
  .milk-grid{display:grid;grid-template-columns:repeat(8,minmax(48px,1fr));gap:6px;align-items:center}
  .milk-item{display:flex;flex-direction:column;align-items:center;gap:4px}
  .milk-item label{font-size:11px;color:var(--muted)}
  .milk-item input{width:56px;padding:6px;border-radius:6px;border:1px solid #eaeaea;text-align:center;height:30px;background:#fff}

  .actions {display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .icon-btn{width:36px;height:36px;border-radius:8px;border:0;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:white}
  .icon-btn.send{background:#25D366}
  .icon-btn.edit{background:#fbbf24;color:#4b2f0a}
  .icon-btn.del{background:#ef4444}
  .icon-btn.custom{background:#3b82f6}
  .icon-btn[title]{position:relative}
  .icon-btn[title]:hover::after{content:attr(title);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.78);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;white-space:nowrap}

  .summary{margin-top:12px;background:#fff6ee;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  .summary-grid{display:grid;grid-template-columns:180px repeat(8,1fr);gap:8px;align-items:center}
  .summary-label{font-weight:800;color:#4b2f0a;font-size:13px}
  .summary-cell{background:var(--card);padding:6px;border-radius:6px;text-align:center;font-weight:700}
  .summary-input{width:62px;padding:6px;border-radius:6px;border:1px solid #eaeaea;text-align:center;height:30px;background:#fff}

  .footer-note{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}
  .top-line{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
  .header-left{display:flex;align-items:center;gap:8px}
  .header-right{display:flex;align-items:center;gap:8px}

  @media (max-width:980px){
    .milk-grid{grid-template-columns:repeat(4,minmax(48px,1fr))}
    .summary-grid{grid-template-columns:140px repeat(4,1fr)}
  }
  @media (max-width:560px){
    .cards-wrap{grid-template-columns:1fr}
    .milk-grid{grid-template-columns:repeat(4,minmax(48px,1fr))}
  }
</style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div class="header-left" style="align-items:center">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 100 100" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="48" fill="#fff" stroke="#f97316" stroke-width="4"/><text x="50" y="58" font-family="sans-serif" font-weight="800" font-size="26" fill="#f97316" text-anchor="middle">HAP</text>
          </svg>
        </div>
      </div>

      <div class="title-block">
        <div class="title">SAMBASHIVA MILK AGENCY</div>
        <div class="subtitle">Prop: <strong>K. AJAY KUMAR REDDY</strong> &nbsp; | &nbsp; Mobile: <strong>7330892694</strong></div>
      </div>

      <div class="header-right">
        <input id="dateInput" class="date-input" type="date" />
      </div>
    </div>
  </header>

  <main class="container" style="padding:12px 14px 80px">
    <div class="top-line">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div style="font-weight:700">Prices (editable)</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="addBtn" class="btn">+ Add Shop</button>
        <button id="copyPrevBtn" class="btn ghost small">üìã Copy Prev Day</button>
        <button id="saveBtn" class="btn ghost small">üíæ Save</button>
        <button id="downloadPdfBtn" class="btn small">‚¨áÔ∏è PDF</button>
        <button id="clearBtn" class="btn clear small">Clear</button>
      </div>
    </div>

    <div class="price-row" aria-hidden="false">
      <div class="price-card"><label>TM (‚Çπ)</label><input id="price_TM" type="number" min="0" value="57"></div>
      <div class="price-card"><label>SM (‚Çπ)</label><input id="price_SM" type="number" min="0" value="67"></div>
      <div class="price-card"><label>SML M (‚Çπ)</label><input id="price_SMM" type="number" min="0" value="45"></div>
      <div class="price-card"><label>SML C (‚Çπ)</label><input id="price_SMC" type="number" min="0" value="45"></div>
      <div class="price-card"><label>A400 (‚Çπ)</label><input id="price_A400" type="number" min="0" value="70"></div>
      <div class="price-card"><label>H500 (‚Çπ)</label><input id="price_H500" type="number" min="0" value="86"></div>
      <div class="price-card"><label>FCM (‚Çπ)</label><input id="price_FC400" type="number" min="0" value="77"></div>
      <div class="price-card"><label>FC1L (‚Çπ)</label><input id="price_FC1L" type="number" min="0" value="76"></div>
    </div>

    <section style="margin-top:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Shops</div>
        <div style="color:var(--muted);font-size:13px">Tap a number to edit ‚Äî Due is editable, Paid auto-calculates</div>
      </div>

      <div id="cards" class="cards-wrap" style="margin-top:10px"></div>

      <div class="summary" style="margin-top:12px">
        <div style="font-weight:800;margin-bottom:8px">Summary</div>
        <div class="summary-grid">
          <div class="summary-label">Metric</div>
          <div class="summary-label">TM</div><div class="summary-label">SM</div><div class="summary-label">SML M</div><div class="summary-label">SML C</div>
          <div class="summary-label">A400</div><div class="summary-label">H500</div><div class="summary-label">FCM</div><div class="summary-label">FC1L</div>

          <div class="summary-label">Total Litres Sold</div>
          <div class="summary-cell" id="b_sold_TM">0</div>
          <div class="summary-cell" id="b_sold_SM">0</div>
          <div class="summary-cell" id="b_sold_SMM">0</div>
          <div class="summary-cell" id="b_sold_SMC">0</div>
          <div class="summary-cell" id="b_sold_A400">0</div>
          <div class="summary-cell" id="b_sold_H500">0</div>
          <div class="summary-cell" id="b_sold_FC400">0</div>
          <div class="summary-cell" id="b_sold_FC1L">0</div>

          <div class="summary-label">Planned Litres</div>
          <div class="summary-cell"><input id="b_plan_TM" class="summary-input" placeholder="0"></div>
          <div class="summary-cell"><input id="b_plan_SM" class="summary-input" placeholder="0"></div>
          <div class="summary-cell"><input id="b_plan_SMM" class="summary-input" placeholder="0"></div>
          <div class="summary-cell"><input id="b_plan_SMC" class="summary-input" placeholder="0"></div>
          <div class="summary-cell"><input id="b_plan_A400" class="summary-input" placeholder="0"></div>
          <div class="summary-cell"><input id="b_plan_H500" class="summary-input" placeholder="0"></div>
          <div class="summary-cell"><input id="b_plan_FC400" class="summary-input" placeholder="0"></div>
          <div class="summary-cell"><input id="b_plan_FC1L" class="summary-input" placeholder="0"></div>

          <div class="summary-label">Remaining</div>
          <div class="summary-cell" id="b_remain_TM">0</div>
          <div class="summary-cell" id="b_remain_SM">0</div>
          <div class="summary-cell" id="b_remain_SMM">0</div>
          <div class="summary-cell" id="b_remain_SMC">0</div>
          <div class="summary-cell" id="b_remain_A400">0</div>
          <div class="summary-cell" id="b_remain_H500">0</div>
          <div class="summary-cell" id="b_remain_FC400">0</div>
          <div class="summary-cell" id="b_remain_FC1L">0</div>
        </div>

        <div style="display:flex;justify-content:space-between;gap:8px;margin-top:10px;align-items:center">
          <div style="font-weight:800">Grand Total: <span id="grandTotal">‚Çπ0</span></div>
          <div style="font-weight:700">Total Litres Sold: <span id="grandLitres">0</span> Ltrs</div>
        </div>
      </div>

      <div class="footer-note">Saved locally on this device ‚Äî data persists after refresh/close. (Last 365 days retained)</div>
    </section>
  </main>

  <div id="toast" style="position:fixed;right:16px;bottom:24px;background:#111;color:#fff;padding:10px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .18s;z-index:200"></div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(() => {
  const STORAGE_PREFIX = 'milkData_';
  const MAX_DAYS = 365;
  const cardsWrap = document.getElementById('cards');
  const dateInput = document.getElementById('dateInput');
  const addBtn = document.getElementById('addBtn');
  const saveBtn = document.getElementById('saveBtn');
  const copyPrevBtn = document.getElementById('copyPrevBtn');
  const clearBtn = document.getElementById('clearBtn');
  const downloadPdfBtn = document.getElementById('downloadPdfBtn');
  const toast = document.getElementById('toast');

  const priceInputs = {
    TM: document.getElementById('price_TM'),
    SM: document.getElementById('price_SM'),
    'SMALL M': document.getElementById('price_SMM'),
    'SMALL C': document.getElementById('price_SMC'),
    A400: document.getElementById('price_A400'),
    H500: document.getElementById('price_H500'),
    FC400: document.getElementById('price_FC400'),
    FC1L: document.getElementById('price_FC1L')
  };

  const summaryIds = {
    sold: { TM:'b_sold_TM', SM:'b_sold_SM', 'SMALL M':'b_sold_SMM', 'SMALL C':'b_sold_SMC', A400:'b_sold_A400', H500:'b_sold_H500', FC400:'b_sold_FC400', FC1L:'b_sold_FC1L' },
    planInputs: { TM:'b_plan_TM', SM:'b_plan_SM', 'SMALL M':'b_plan_SMM', 'SMALL C':'b_plan_SMC', A400:'b_plan_A400', H500:'b_plan_H500', FC400:'b_plan_FC400', FC1L:'b_plan_FC1L' },
    remain: { TM:'b_remain_TM', SM:'b_remain_SM', 'SMALL M':'b_remain_SMM', 'SMALL C':'b_remain_SMC', A400:'b_remain_A400', H500:'b_remain_H500', FC400:'b_remain_FC400', FC1L:'b_remain_FC1L' }
  };

  const grandTotalEl = document.getElementById('grandTotal');
  const grandLitresEl = document.getElementById('grandLitres');

  const now = new Date();
  const TODAY = now.toISOString().slice(0,10);

  function showToast(msg, ms = 1400){
    toast.textContent = msg; toast.style.opacity = 1; toast.style.transform = 'none';
    clearTimeout(toast._t); toast._t = setTimeout(()=>{ toast.style.opacity = 0; toast.style.transform = 'translateY(8px)'; }, ms);
  }

  function keyForDate(d){ return STORAGE_PREFIX + d; }
  function listSavedDates(){ const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith(STORAGE_PREFIX)) keys.push(k.slice(STORAGE_PREFIX.length)); } return keys.sort(); }
  function deleteOldRecords(){ const keys = listSavedDates(); if(!keys.length) return 0; const now = new Date(); const cutoff = new Date(now); cutoff.setDate(cutoff.getDate() - MAX_DAYS); let deleted = 0; keys.forEach(d=>{ const dt = new Date(d + 'T00:00:00'); if(dt < cutoff){ localStorage.removeItem(keyForDate(d)); deleted++; } }); if(deleted) showToast(`Deleted ${deleted} old record(s)`); return deleted; }

  function readGlobalPrices(){
    return {
      TM: Number(priceInputs.TM.value||0),
      SM: Number(priceInputs.SM.value||0),
      'SMALL M': Number(priceInputs['SMALL M'].value||0),
      'SMALL C': Number(priceInputs['SMALL C'].value||0),
      A400: Number(priceInputs.A400.value||0),
      H500: Number(priceInputs.H500.value||0),
      FC400: Number(priceInputs.FC400.value||0),
      FC1L: Number(priceInputs.FC1L.value||0)
    };
  }

  // utility
  function formatNum(n){ if(!isFinite(n)) return '0'; if(Math.round(n)===n) return String(Math.round(n)); return Number(n).toFixed(2); }

  // create card element
  function createCard(data){
    const div = document.createElement('div');
    div.className = 'shop-card';
    div.innerHTML = `
      <div class="shop-top">
        <div style="flex:1">
          <div class="shop-name"><input class="c_name" type="text" placeholder="Full name" style="font-weight:800;border:0;background:transparent;width:100%"></div>
          <div class="shop-mobile"><input class="c_mobile" type="tel" placeholder="Mobile" style="border:0;background:transparent;width:100%"></div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div class="amount-box"><label style="font-size:11px;color:var(--muted)">Paid</label><strong class="c_paid">0</strong></div>
            <div class="amount-box"><label style="font-size:11px;color:var(--muted)">Due</label><input class="c_due" type="number" placeholder="0" style="width:80px"></div>
          </div>
          <div style="margin-top:8px" class="actions-row">
            <div class="actions">
              <button class="icon-btn send" title="Send to WhatsApp">‚úâÔ∏è</button>
              <button class="icon-btn edit" title="Edit">‚úèÔ∏è</button>
              <button class="icon-btn del" title="Delete">üóëÔ∏è</button>
              <button class="icon-btn custom" title="Toggle custom prices">‚≠ê</button>
            </div>
          </div>
        </div>
        <div style="width:280px">
          <div class="milk-grid">
            <div class="milk-item"><label>TM</label><input class="c_tm" type="number" placeholder="0"></div>
            <div class="milk-item"><label>SM</label><input class="c_sm" type="number" placeholder="0"></div>
            <div class="milk-item"><label>SML M</label><input class="c_smm" type="number" placeholder="0"></div>
            <div class="milk-item"><label>SML C</label><input class="c_smc" type="number" placeholder="0"></div>
            <div class="milk-item"><label>A400</label><input class="c_a400" type="number" placeholder="0"></div>
            <div class="milk-item"><label>H500</label><input class="c_h500" type="number" placeholder="0"></div>
            <div class="milk-item"><label>FCM</label><input class="c_fc400" type="number" placeholder="0"></div>
            <div class="milk-item"><label>FC1L</label><input class="c_fc1l" type="number" placeholder="0"></div>
          </div>
          <div style="margin-top:8px;text-align:center;font-weight:800">Total: <span class="c_total">0</span></div>
        </div>
      </div>
    `;

    // fill data
    if(data){
      div.querySelector('.c_name').value = data.shop || '';
      div.querySelector('.c_mobile').value = data.mobile || '';
      div.querySelector('.c_tm').value = data.TM || '';
      div.querySelector('.c_sm').value = data.SM || '';
      div.querySelector('.c_smm').value = data.SMALLM || '';
      div.querySelector('.c_smc').value = data.SMALLC || '';
      div.querySelector('.c_a400').value = data.A400 || '';
      div.querySelector('.c_h500').value = data.H500 || '';
      div.querySelector('.c_fc400').value = data.FC400 || '';
      div.querySelector('.c_fc1l').value = data.FC1L || '';
      div.querySelector('.c_due').value = (data.due || '') ;
      if(data.customPrices) div._customPrices = data.customPrices;
    }

    // query subs
    const nameI = div.querySelector('.c_name');
    const mobileI = div.querySelector('.c_mobile');
    const dueI = div.querySelector('.c_due');
    const paidEl = div.querySelector('.c_paid');
    const totalEl = div.querySelector('.c_total');
    const inputs = Array.from(div.querySelectorAll('.milk-grid input'));

    // calc row
    function calc(){
      const g = readGlobalPrices();
      const custom = div._customPrices || null;
      const tm = Number(div.querySelector('.c_tm').value||0);
      const sm = Number(div.querySelector('.c_sm').value||0);
      const smm = Number(div.querySelector('.c_smm').value||0);
      const smc = Number(div.querySelector('.c_smc').value||0);
      const a400 = Number(div.querySelector('.c_a400').value||0);
      const h500 = Number(div.querySelector('.c_h500').value||0);
      const fc400 = Number(div.querySelector('.c_fc400').value||0);
      const fc1l = Number(div.querySelector('.c_fc1l').value||0);

      const p = {
        TM: (custom && typeof custom.TM === 'number') ? custom.TM : g.TM,
        SM: (custom && typeof custom.SM === 'number') ? custom.SM : g.SM,
        'SMALL M': (custom && typeof custom['SMALL M'] === 'number') ? custom['SMALL M'] : g['SMALL M'],
        'SMALL C': (custom && typeof custom['SMALL C'] === 'number') ? custom['SMALL C'] : g['SMALL C'],
        A400: (custom && typeof custom.A400 === 'number') ? custom.A400 : g.A400,
        H500: (custom && typeof custom.H500 === 'number') ? custom.H500 : g.H500,
        FC400: (custom && typeof custom.FC400 === 'number') ? custom.FC400 : g.FC400,
        FC1L: (custom && typeof custom.FC1L === 'number') ? custom.FC1L : g.FC1L
      };

      const total = (tm*p.TM) + (sm*p.SM) + (smm * p['SMALL M']) + (smc * p['SMALL C']) + (a400 * p.A400) + (h500 * p.H500) + (fc400 * p.FC400) + (fc1l * p.FC1L);
      totalEl.textContent = formatNum(total);

      // Due editable => paid auto calc
      const dueVal = Number(dueI.value||0);
      const paidVal = Math.max(0, total - dueVal);
      paidEl.textContent = formatNum(paidVal);

      // highlight states
      if(div._customPrices) div.classList.add('yellow'); else div.classList.remove('yellow');
      if(Number(dueI.value||0) > 0) div.classList.add('red'); else div.classList.remove('red');
    }

    // attach input listeners
    [nameI, mobileI, dueI, ...inputs].forEach(inp=>{
      inp.addEventListener('input', ()=>{ calc(); updateAll(); autosave(); });
    });

    // icon buttons
    const sendBtn = div.querySelector('.icon-btn.send');
    const editBtn = div.querySelector('.icon-btn.edit');
    const delBtn = div.querySelector('.icon-btn.del');
    const customBtn = div.querySelector('.icon-btn.custom');

    sendBtn.addEventListener('click', ()=> sendWhatsApp(div));
    editBtn.addEventListener('click', ()=> {
      // toggle focus to name
      nameI.focus(); nameI.select();
    });
    delBtn.addEventListener('click', ()=> {
      if(confirm('Delete this shop?')){ if(div.nextSibling && div.nextSibling._isCustomEditor) div.parentNode.removeChild(div.nextSibling); div.parentNode.removeChild(div); updateAll(); autosave(); }
    });

    customBtn.addEventListener('click', ()=> openCustomEditor(div));

    // initial calc
    calc();

    return div;
  }

  // open custom editor below card
  function openCustomEditor(card){
    // if already open remove
    if(card.nextSibling && card.nextSibling._isCustomEditor){ card.parentNode.removeChild(card.nextSibling); return; }
    // create editor
    const ed = document.createElement('div');
    ed.style.background = '#fff8ed';
    ed.style.padding = '10px';
    ed.style.borderRadius = '10px';
    ed.style.boxShadow = '0 6px 18px rgba(2,6,23,0.04)';
    ed.style.gridColumn = '1/-1';
    ed._isCustomEditor = true;
    ed.innerHTML = `
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <div style="font-weight:800;color:#7a4300">Custom prices for this shop</div>
        <label>TM ‚Çπ<input class="ed_tm" type="number" style="width:90px;padding:6px;border-radius:6px"></label>
        <label>SM ‚Çπ<input class="ed_sm" type="number" style="width:90px;padding:6px;border-radius:6px"></label>
        <label>SML M ‚Çπ<input class="ed_smm" type="number" style="width:90px;padding:6px;border-radius:6px"></label>
        <label>SML C ‚Çπ<input class="ed_smc" type="number" style="width:90px;padding:6px;border-radius:6px"></label>
        <label>A400 ‚Çπ<input class="ed_a400" type="number" style="width:90px;padding:6px;border-radius:6px"></label>
        <label>H500 ‚Çπ<input class="ed_h500" type="number" style="width:90px;padding:6px;border-radius:6px"></label>
        <label>FCM ‚Çπ<input class="ed_fc400" type="number" style="width:90px;padding:6px;border-radius:6px"></label>
        <label>FC1L ‚Çπ<input class="ed_fc1l" type="number" style="width:90px;padding:6px;border-radius:6px"></label>
        <button class="btn save-custom small">Save</button>
        <button class="btn ghost small cancel-custom">Cancel</button>
      </div>
    `;
    // set current values
    const g = readGlobalPrices();
    ed.querySelector('.ed_tm').value = (card._customPrices && typeof card._customPrices.TM === 'number') ? card._customPrices.TM : g.TM;
    ed.querySelector('.ed_sm').value = (card._customPrices && typeof card._customPrices.SM === 'number') ? card._customPrices.SM : g.SM;
    ed.querySelector('.ed_smm').value = (card._customPrices && typeof card._customPrices['SMALL M'] === 'number') ? card._customPrices['SMALL M'] : g['SMALL M'];
    ed.querySelector('.ed_smc').value = (card._customPrices && typeof card._customPrices['SMALL C'] === 'number') ? card._customPrices['SMALL C'] : g['SMALL C'];
    ed.querySelector('.ed_a400').value = (card._customPrices && typeof card._customPrices.A400 === 'number') ? card._customPrices.A400 : g.A400;
    ed.querySelector('.ed_h500').value = (card._customPrices && typeof card._customPrices.H500 === 'number') ? card._customPrices.H500 : g.H500;
    ed.querySelector('.ed_fc400').value = (card._customPrices && typeof card._customPrices.FC400 === 'number') ? card._customPrices.FC400 : g.FC400;
    ed.querySelector('.ed_fc1l').value = (card._customPrices && typeof card._customPrices.FC1L === 'number') ? card._customPrices.FC1L : g.FC1L;

    // attach
    card.parentNode.insertBefore(ed, card.nextSibling);

    ed.querySelector('.cancel-custom').addEventListener('click', ()=> {
      if(ed && ed.parentNode) ed.parentNode.removeChild(ed);
    });
    ed.querySelector('.save-custom').addEventListener('click', ()=> {
      card._customPrices = {
        TM: Number(ed.querySelector('.ed_tm').value||0),
        SM: Number(ed.querySelector('.ed_sm').value||0),
        'SMALL M': Number(ed.querySelector('.ed_smm').value||0),
        'SMALL C': Number(ed.querySelector('.ed_smc').value||0),
        A400: Number(ed.querySelector('.ed_a400').value||0),
        H500: Number(ed.querySelector('.ed_h500').value||0),
        FC400: Number(ed.querySelector('.ed_fc400').value||0),
        FC1L: Number(ed.querySelector('.ed_fc1l').value||0)
      };
      if(ed && ed.parentNode) ed.parentNode.removeChild(ed);
      // recalc card
      const calcBtn = card.querySelector('.c_tm');
      if(calcBtn) { // trigger calc
        Array.from(card.querySelectorAll('input')).forEach(i=>i.dispatchEvent(new Event('input')));
      }
      showToast('Custom prices saved');
      autosave();
    });
  }

  function sendWhatsApp(card){
    const name = card.querySelector('.c_name').value || 'Customer';
    let mobile = (card.querySelector('.c_mobile').value||'').replace(/\D/g,'');
    if(!mobile){ alert('Please enter mobile'); return; }
    if(mobile.length>10 && mobile.startsWith('91')) mobile = mobile.slice(-10);
    if(mobile.length !== 10){ alert('Enter valid 10-digit mobile'); return; }

    const tm = Number(card.querySelector('.c_tm').value||0);
    const sm = Number(card.querySelector('.c_sm').value||0);
    const smm = Number(card.querySelector('.c_smm').value||0);
    const smc = Number(card.querySelector('.c_smc').value||0);
    const a400 = Number(card.querySelector('.c_a400').value||0);
    const h500 = Number(card.querySelector('.c_h500').value||0);
    const fc400 = Number(card.querySelector('.c_fc400').value||0);
    const fc1l = Number(card.querySelector('.c_fc1l').value||0);

    const total = card.querySelector('.c_total').textContent || '0';
    const paid = card.querySelector('.c_paid').textContent || '0';
    const due = card.querySelector('.c_due').value || '0';
    const date = dateInput.value || TODAY;

    const g = readGlobalPrices();
    const custom = card._customPrices || null;
    const p = {
      TM: custom&&typeof custom.TM==='number'?custom.TM:g.TM,
      SM: custom&&typeof custom.SM==='number'?custom.SM:g.SM,
      'SMALL M': custom&&typeof custom['SMALL M']==='number'?custom['SMALL M']:g['SMALL M'],
      'SMALL C': custom&&typeof custom['SMALL C']==='number'?custom['SMALL C']:g['SMALL C'],
      A400: custom&&typeof custom.A400==='number'?custom.A400:g.A400,
      H500: custom&&typeof custom.H500==='number'?custom.H500:g.H500,
      FC400: custom&&typeof custom.FC400==='number'?custom.FC400:g.FC400,
      FC1L: custom&&typeof custom.FC1L==='number'?custom.FC1L:g.FC1L
    };

    let msg = `Hello ${name},%0AMilk bill for ${date}:%0A`;
    const lines = [];
    if(tm) lines.push(`TM ${tm} x ${p.TM} = ${(tm*p.TM).toFixed(2)}`);
    if(sm) lines.push(`SM ${sm} x ${p.SM} = ${(sm*p.SM).toFixed(2)}`);
    if(smm) lines.push(`SML M ${smm} x ${p['SMALL M']} = ${(smm*p['SMALL M']).toFixed(2)}`);
    if(smc) lines.push(`SML C ${smc} x ${p['SMALL C']} = ${(smc*p['SMALL C']).toFixed(2)}`);
    if(a400) lines.push(`A400 ${a400} x ${p.A400} = ${(a400*p.A400).toFixed(2)}`);
    if(h500) lines.push(`H500 ${h500} x ${p.H500} = ${(h500*p.H500).toFixed(2)}`);
    if(fc400) lines.push(`FCM ${fc400} x ${p.FC400} = ${(fc400*p.FC400).toFixed(2)}`);
    if(fc1l) lines.push(`FC1L ${fc1l} x ${p.FC1L} = ${(fc1l*p.FC1L).toFixed(2)}`);
    if(lines.length) msg += lines.join('%0A') + '%0A';
    msg += `Total: ‚Çπ${total}%0APaid: ‚Çπ${paid}%0ADue: ‚Çπ${due}%0A- Sambashiva Milk Agency`;
    window.open(`https://wa.me/91${mobile}?text=${msg}`, '_blank');
  }

  // create + append new shop
  function addShop(data){
    const card = createCard(data || {});
    cardsWrap.appendChild(card);
    // scroll into view
    setTimeout(()=> card.scrollIntoView({behavior:'smooth', block:'center'}), 60);
    autosave();
  }

  // collect rows for saving/export
  function collectRows(){
    const rows = [];
    const cards = Array.from(cardsWrap.children).filter(c=>!c._isCustomEditor);
    cards.forEach(c=>{
      rows.push({
        shop: c.querySelector('.c_name').value || '',
        mobile: c.querySelector('.c_mobile').value || '',
        TM: Number(c.querySelector('.c_tm').value||0),
        SM: Number(c.querySelector('.c_sm').value||0),
        SMALLM: Number(c.querySelector('.c_smm').value||0),
        SMALLC: Number(c.querySelector('.c_smc').value||0),
        A400: Number(c.querySelector('.c_a400').value||0),
        H500: Number(c.querySelector('.c_h500').value||0),
        FC400: Number(c.querySelector('.c_fc400').value||0),
        FC1L: Number(c.querySelector('.c_fc1l').value||0),
        due: Number(c.querySelector('.c_due').value||0),
        customPrices: c._customPrices || null
      });
    });
    return rows;
  }

  // save/load
  function saveForDate(d){
    try{
      const payload = {
        date: d,
        prices: readGlobalPrices(),
        rows: collectRows()
      };
      localStorage.setItem(keyForDate(d), JSON.stringify(payload));
      return true;
    }catch(e){ console.error(e); return false; }
  }
  function loadForDate(d, copyPrev=true){
    // save current
    const curNow = dateInput._current || TODAY;
    if(curNow && curNow !== d) saveForDate(curNow);

    dateInput._current = d; dateInput.value = d;
    const raw = localStorage.getItem(keyForDate(d));
    if(raw){
      try{
        const obj = JSON.parse(raw);
        if(obj.prices) {
          Object.keys(priceInputs).forEach(k=>{ if(typeof obj.prices[k] !== 'undefined') priceInputs[k].value = obj.prices[k]; });
        }
        cardsWrap.innerHTML = '';
        if(Array.isArray(obj.rows) && obj.rows.length){
          obj.rows.forEach(r=> addShop(r));
          updateAll();
          return;
        }
      }catch(e){ console.error(e); }
    }

    // copy prev shops (only names & mobiles & custom prices)
    if(copyPrev){
      const prev = previousDate(d);
      const prevRaw = localStorage.getItem(keyForDate(prev));
      if(prevRaw){
        try{
          const prevObj = JSON.parse(prevRaw);
          if(Array.isArray(prevObj.rows) && prevObj.rows.length){
            cardsWrap.innerHTML = '';
            prevObj.rows.forEach(r=>{
              const newR = { shop: r.shop||'', mobile: r.mobile||'', TM:0, SM:0, SMALLM:0, SMALLC:0, A400:0, H500:0, FC400:0, FC1L:0, due:0, customPrices: r.customPrices||null };
              addShop(newR);
            });
            updateAll();
            saveForDate(d);
            showToast('Copied shops & custom prices from previous day');
            return;
          }
        }catch(e){ console.error(e); }
      }
    }

    // default: empty card
    cardsWrap.innerHTML = '';
    addShop();
    updateAll();
  }

  function previousDate(d){
    const dt = new Date(d + 'T00:00:00'); dt.setDate(dt.getDate() - 1);
    return dt.toISOString().slice(0,10);
  }

  // update summary and totals
  function updateAll(){
    // sums
    let tmSum=0, smSum=0, smmSum=0, smcSum=0, a400Sum=0, h500Sum=0, fc400Sum=0, fc1lSum=0;
    let totalMoney=0, paidSum=0, dueSum=0;
    const cards = Array.from(cardsWrap.children).filter(c=>!c._isCustomEditor);
    cards.forEach(c=>{
      const tm = Number(c.querySelector('.c_tm').value||0), sm = Number(c.querySelector('.c_sm').value||0),
        smm = Number(c.querySelector('.c_smm').value||0), smc = Number(c.querySelector('.c_smc').value||0),
        a400 = Number(c.querySelector('.c_a400').value||0), h500 = Number(c.querySelector('.c_h500').value||0),
        fc400 = Number(c.querySelector('.c_fc400').value||0), fc1l = Number(c.querySelector('.c_fc1l').value||0);

      // total money is taken from displayed total (string)
      const total = parseFloat((c.querySelector('.c_total').textContent||'0').replace(/,/g,''))||0;
      const paid = parseFloat((c.querySelector('.c_paid').textContent||'0').replace(/,/g,''))||0;
      const due = Number(c.querySelector('.c_due').value||0);

      tmSum += tm; smSum += sm; smmSum += smm; smcSum += smc; a400Sum += a400; h500Sum += h500; fc400Sum += fc400; fc1lSum += fc1l;
      totalMoney += total; paidSum += paid; dueSum += due;
    });

    document.getElementById(summaryIds.sold.TM).textContent = formatNum(tmSum);
    document.getElementById(summaryIds.sold.SM).textContent = formatNum(smSum);
    document.getElementById(summaryIds.sold['SMALL M']).textContent = formatNum(smmSum);
    document.getElementById(summaryIds.sold['SMALL C']).textContent = formatNum(smcSum);
    document.getElementById(summaryIds.sold.A400).textContent = formatNum(a400Sum);
    document.getElementById(summaryIds.sold.H500).textContent = formatNum(h500Sum);
    document.getElementById(summaryIds.sold.FC400).textContent = formatNum(fc400Sum);
    document.getElementById(summaryIds.sold.FC1L).textContent = formatNum(fc1lSum);

    // planned -> read from bottom inputs (user may edit any of them)
    const types = ['TM','SM','SMALL M','SMALL C','A400','H500','FC400','FC1L'];
    types.forEach(t=>{
      const el = document.getElementById(summaryIds.planInputs[t]);
      if(el) {
        const val = Number(el.value||0);
        // update remain
        const remainEl = document.getElementById(summaryIds.remain[t]);
        if(remainEl) remainEl.textContent = formatNum(Math.max(0, val - (Number(document.getElementById(summaryIds.sold[t]).textContent||0))));
      }
    });

    grandTotalEl.textContent = `‚Çπ${formatNum(totalMoney)}`;
    grandLitresEl.textContent = formatNum(tmSum + smSum + smmSum + smcSum + a400Sum + h500Sum + fc400Sum + fc1lSum);
  }

  // autosave
  function autosave(){ saveForDate(dateInput.value || TODAY); }
  function saveAndNotify(){ saveForDate(dateInput.value || TODAY); showToast('Saved'); }

  // doc listeners init
  function init(){
    dateInput.value = TODAY;
    deleteOldRecords();
    loadForDate(TODAY, true);

    addBtn.addEventListener('click', ()=> { addShop(); updateAll(); autosave(); });
    saveBtn.addEventListener('click', ()=> saveAndNotify());
    copyPrevBtn.addEventListener('click', ()=> {
      const cur = dateInput.value || TODAY;
      const prev = previousDate(cur);
      const prevRaw = localStorage.getItem(keyForDate(prev));
      if(!prevRaw){ alert('No data for previous day'); return; }
      if(!confirm('Copy shops & custom prices from previous day? Quantities and due will be reset.')) return;
      try{
        const prevObj = JSON.parse(prevRaw);
        if(Array.isArray(prevObj.rows) && prevObj.rows.length){
          prevObj.rows.forEach(r=>{
            const newRow = { shop: r.shop||'', mobile: r.mobile||'', TM:0, SM:0, SMALLM:0, SMALLC:0, A400:0, H500:0, FC400:0, FC1L:0, due:0, customPrices: r.customPrices||null };
            addShop(newRow);
          });
          updateAll(); autosave(); showToast('Copied from previous day');
        }
      }catch(e){ console.error(e); alert('Copy failed'); }
    });

    clearBtn.addEventListener('click', ()=> {
      if(confirm('Clear all data for this date? This will remove rows & saved data for this date only.')) {
        localStorage.removeItem(keyForDate(dateInput.value || TODAY));
        cardsWrap.innerHTML=''; addShop(); updateAll(); autosave(); showToast('Cleared');
      }
    });

    downloadPdfBtn.addEventListener('click', ()=> downloadPdfDirect());

    // price changes should recalc all
    Object.values(priceInputs).forEach(inp=>{
      inp.addEventListener('input', ()=> {
        Array.from(cardsWrap.querySelectorAll('.shop-card')).forEach(c=> Array.from(c.querySelectorAll('input')).forEach(i=> i.dispatchEvent(new Event('input'))));
        updateAll(); autosave();
      });
    });

    // summary plan inputs reflect main plan fields
    Object.keys(summaryIds.planInputs).forEach(k=>{
      const el = document.getElementById(summaryIds.planInputs[k]);
      if(!el) return;
      el.addEventListener('input', ()=> {
        document.getElementById(summaryIds.remain[k]).textContent = formatNum(Math.max(0, Number(el.value||0) - Number(document.getElementById(summaryIds.sold[k]).textContent||0)));
        // copy up to top plan row if exists
        const topPlan = document.getElementById('plan_TM');
        if(topPlan && k === 'TM') topPlan.value = el.value;
        updateAll();
        autosave();
      });
    });

    dateInput.addEventListener('change', ()=> {
      const newDate = dateInput.value || TODAY; loadForDate(newDate, true); showToast(`Loaded ${newDate}`);
    });

    window.addEventListener('beforeunload', ()=> saveForDate(dateInput.value || TODAY));
  }

  // PDF generation: full page portrait A4
  async function downloadPdfDirect(){
    try{
      showToast('Preparing PDF...');
      const elem = document.body;
      const canvas = await html2canvas(elem, { scale: 2, useCORS:true, allowTaint:true });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pageWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      if(imgHeight <= pageHeight){
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      } else {
        const canvasH = canvas.height;
        const sliceH = Math.floor(canvas.width * (pageHeight / pageWidth));
        let y = 0;
        while(y < canvasH){
          const slice = document.createElement('canvas');
          slice.width = canvas.width;
          slice.height = Math.min(sliceH, canvasH - y);
          const ctx = slice.getContext('2d');
          ctx.drawImage(canvas, 0, y, canvas.width, slice.height, 0, 0, slice.width, slice.height);
          const sliceData = slice.toDataURL('image/png');
          const sliceImgH = (slice.height * imgWidth) / canvas.width;
          pdf.addImage(sliceData, 'PNG', 0, 0, imgWidth, sliceImgH);
          y += sliceH;
          if(y < canvasH) pdf.addPage();
        }
      }
      const filename = `MilkReport_${(dateInput.value||TODAY)}.pdf`;
      pdf.save(filename);
      showToast('PDF downloaded');
    }catch(e){ console.error(e); alert('PDF generation failed: ' + (e && e.message)); }
  }

  // load saved data for date
  function loadForDate(d, copyPrev = true){
    // save current before switching
    const curNow = dateInput._current || TODAY;
    if(curNow && curNow !== d) saveForDate(curNow);

    dateInput._current = d; dateInput.value = d;
    const raw = localStorage.getItem(keyForDate(d));
    if(raw){
      try{
        const obj = JSON.parse(raw);
        if(obj.prices){
          Object.keys(priceInputs).forEach(k=>{ if(typeof obj.prices[k] !== 'undefined') priceInputs[k].value = obj.prices[k]; });
        }
        cardsWrap.innerHTML = '';
        if(Array.isArray(obj.rows) && obj.rows.length){
          obj.rows.forEach(r=> addShop(r));
          updateAll();
          return;
        }
      }catch(e){ console.error(e); }
    }
    // copy prev if available
    if(copyPrev){
      const prev = previousDate(d);
      const prevRaw = localStorage.getItem(keyForDate(prev));
      if(prevRaw){
        try{
          const prevObj = JSON.parse(prevRaw);
          if(Array.isArray(prevObj.rows) && prevObj.rows.length){
            cardsWrap.innerHTML = '';
            prevObj.rows.forEach(r=>{
              const newR = { shop: r.shop||'', mobile: r.mobile||'', TM:0, SM:0, SMALLM:0, SMALLC:0, A400:0, H500:0, FC400:0, FC1L:0, due:0, customPrices: r.customPrices||null };
              addShop(newR);
            });
            updateAll();
            saveForDate(d);
            showToast('Copied shops & custom prices from previous day');
            return;
          }
        }catch(e){ console.error(e); }
      }
    }
    // default blank
    cardsWrap.innerHTML = ''; addShop(); updateAll();
  }

  // save API
  function saveForDate(d){
    try{
      const payload = { date: d, prices: readGlobalPrices(), rows: collectRows() };
      localStorage.setItem(keyForDate(d), JSON.stringify(payload));
      return true;
    }catch(e){ console.error(e); return false; }
  }

  // init app
  init();

})();
</script>
</body>
</html>
